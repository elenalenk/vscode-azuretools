steps:
  - task: Npm@1
    displayName: "\U0001F449 Package"
    inputs:
      command: custom
      customCommand: run package
      workingDir: $(working_directory)
    condition: succeeded()

  - pwsh: | 
      Write-Output "##vso[task.setvariable variable=name;isOutput=true]$((Get-Content -Raw -Path package.json | ConvertFrom-Json).name)"
      Write-Output "##vso[task.setvariable variable=version;isOutput=true]$((Get-Content -Raw -Path package.json | ConvertFrom-Json).version)"
    name: package
    displayName: Get extension info package.json

  - script: npx @vscode/vsce@latest generate-manifest -i $(package.name)-$(package.version).vsix -o $(Build.SourcesDirectory)/extension.manifest
    displayName: 'Generate extension manifest'

  - script: copy $(Build.SourcesDirectory)\extension.manifest $(Build.SourcesDirectory)\extension.signature.p7s
    displayName: 'Prepare manifest for signing'

  - script: node $(Build.SourcesDirectory)/build/sign.js
    displayName: 'Sign extension manifest'

  - task: CopyFiles@2
    displayName: "\U0001F449 Copy packages and vsix to staging directory"
    inputs:
      Contents: |
        **/*.vsix
        **/*.manifest
        **/*.p7s
        **/*.tar.gz
        **/*.tgz
        package.json
      TargetFolder: "$(build.artifactstagingdirectory)/build/$(artifact_name)"
    condition: and(succeeded(), ne(variables['System.PullRequest.IsFork'], 'True'))